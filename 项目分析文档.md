# NetScanDemo 项目分析文档

## 一、项目概述

### 1.1 项目性质
NetScanDemo 是一个基于 **MFC (Microsoft Foundation Classes)** 框架开发的 **喷墨打印控制系统** 演示程序。该项目主要用于控制网络扫描式喷墨打印设备，提供完整的打印作业管理、设备参数配置、图像处理等功能。

### 1.2 技术栈
- **开发框架**: MFC (动态链接库方式)
- **开发工具**: Visual Studio 2010
- **编程语言**: C++
- **字符集**: Unicode (Win32) / MultiByte (x64)
- **外部库**: RYPrtCtler.lib (融跃打印控制库)
- **可选模块**: MoveCtl.lib (运动控制库，需定义 RY_MOVE_CTL)

### 1.3 项目结构
```
NetScanDemoPrtSeparate_0818_ai_parse/
├── NetScanDemo/          # 主项目目录
│   ├── *.cpp/*.h         # 源文件和头文件
│   ├── res/              # 资源文件
│   └── NetScanDemo.rc    # 资源脚本
├── Inc/                  # 头文件目录
│   ├── ryprtapi.h        # 打印API接口定义
│   ├── RYPrtCtler.h      # 打印控制器接口
│   └── MoveCtl.h         # 运动控制接口（可选）
└── lib/                  # 库文件目录
    ├── x86/              # 32位库
    └── x64/              # 64位库
```

---

## 二、核心处理逻辑

### 2.1 应用程序启动流程

```12:123:NetScanDemo/NetScanDemo.cpp
BOOL CNetScanDemoApp::InitInstance()
{
	// 初始化通用控件
	INITCOMMONCONTROLSEX InitCtrls;
	InitCtrls.dwSize = sizeof(InitCtrls);
	InitCtrls.dwICC = ICC_WIN95_CLASSES;
	InitCommonControlsEx(&InitCtrls);

	CWinApp::InitInstance();
	AfxEnableControlContainer();

	// 创建Shell管理器
	CShellManager *pShellManager = new CShellManager;

	// 设置注册表键
	SetRegistryKey(_T("Local AppWizard-Generated Applications"));
	LoadStdProfileSettings();
	
	// 获取应用程序路径
	// ... 路径获取代码 ...
	
	// 加载运动控制参数（如果启用）
#ifdef RY_MOVE_CTL
	LoadMoveParam();
#endif

	// 创建并显示主对话框
	CNetScanDemoDlg dlg;
	dlg.m_szAppPath = m_szAppPath;
	m_pMainWnd = &dlg;
	INT_PTR nResponse = dlg.DoModal();
	
	// 保存参数
	SaveParam(&g_sysParam);
	SaveCalibrationParam();
#ifdef RY_MOVE_CTL
	SaveMoveParam();
#endif
	
	return FALSE;
}
```

**流程说明**:
1. 初始化 Windows 通用控件
2. 启用 ActiveX 控件容器
3. 获取应用程序路径
4. 加载配置参数（用户参数、运动参数等）
5. 创建并显示主对话框（模态对话框）
6. 程序退出时保存所有参数

### 2.2 打印作业处理流程

#### 2.2.1 打印作业启动
主对话框中的 `OnBnClickedButtonStartjob()` 函数处理打印作业的启动：

**关键步骤**:
1. **图像加载验证**: 检查是否已加载打印图像
2. **作业参数配置**: 弹出 `CPrtJobDlg` 对话框配置作业参数
3. **创建打印线程**: 
   - `PrintThreadSeparate`: 分离式打印线程
   - `PrintThread`: 主打印线程
4. **创建互斥锁**: 用于线程同步
5. **状态更新**: 更新按钮状态和界面显示

#### 2.2.2 打印线程处理
打印线程采用多线程架构：
- **PrintThread**: 负责打印数据发送和设备控制
- **PrintThreadSeparate**: 负责分离式打印处理
- **MonitorThread**: 负责设备状态监控

### 2.3 参数管理流程

#### 2.3.1 参数类型
项目管理以下类型的参数：
1. **用户参数** (`RYUSR_PARAM`): 存储在 `userparam.dat`
2. **图层参数** (`PRTIMG_LAYER`): 存储在 `pmc.dat`
3. **作业参数** (`PRTJOB_ITEM`): 存储在 `job.dat`
4. **校准参数** (`RYCalbrationParam`): 存储在 `Calibration.dat`
5. **运动参数** (`MOV_Config`): 存储在 `moveParam.dat` (可选)

#### 2.3.2 参数加载/保存机制
所有参数使用 `CFile` 类进行二进制文件读写：
- **加载**: `LoadParam()`, `LoadLayerParam()`, `LoadJobParam()`, `LoadCalibrationParam()`
- **保存**: `SaveParam()`, `SaveLayerParam()`, `SaveJobParam()`, `SaveCalibrationParam()`

---

## 三、模块功能分工

### 3.1 应用程序类模块

#### 3.1.1 CNetScanDemoApp (应用程序类)
**文件**: `NetScanDemo.h`, `NetScanDemo.cpp`

**功能**:
- 应用程序生命周期管理
- 参数文件读写（用户参数、图层参数、作业参数、校准参数）
- 应用程序路径管理
- 全局参数对象管理

**关键成员**:
- `m_szAppPath`: 应用程序路径
- `InitInstance()`: 应用程序初始化
- `LoadParam()` / `SaveParam()`: 参数加载/保存

**MFC特性**:
- 继承自 `CWinApp` (MFC应用程序基类)
- 使用消息映射 (`DECLARE_MESSAGE_MAP`)
- 使用预编译头 (`stdafx.h`)

---

### 3.2 主对话框模块

#### 3.2.1 CNetScanDemoDlg (主对话框)
**文件**: `NetScanDemoDlg.h`, `NetScanDemoDlg.cpp`

**功能**:
- 主界面显示和控制
- 打印作业管理（启动/停止）
- 图像加载和预览
- 设备信息显示
- 系统初始化

**关键成员变量**:
- `m_bJobStarted`: 作业是否已启动
- `m_bPrinting`: 是否正在打印
- `m_ListPrtInfo`: 打印信息列表控件
- `m_ListDrvInfo`: 驱动信息列表控件
- `m_ImgPreView`: 图像预览控件
- `m_pPrtData[]`: 打印数据缓冲区

**关键成员函数**:
- `OnInitDialog()`: 对话框初始化
- `OnBnClickedButtonStartjob()`: 启动/停止打印作业
- `OnBnClickedButtonLoadimg()`: 加载图像
- `InitSystem()`: 初始化系统
- `UpdateVTListInfo()`: 更新设备信息列表
- `PrintThread()`: 打印线程函数（静态）
- `MonitorThread()`: 监控线程函数（静态）

**MFC特性**:
- 继承自 `CDialogEx` (扩展对话框类)
- 使用 `DoDataExchange()` 进行数据交换 (DDX/DDV)
- 使用消息映射处理控件事件
- 使用 `AfxBeginThread()` 创建工作线程

---

### 3.3 参数配置对话框模块

#### 3.3.1 CSysParamDlg (系统参数对话框)
**文件**: `CSysParamDlg.h`, `CSysParamDlg.cpp`

**功能**:
- 系统参数配置
- 打印头参数设置
- 微喷参数配置
- 闪喷参数配置
- 日志路径设置

**关键参数**:
- `m_fCBDistance`: 打印头距离
- `m_fCBWidth`: 打印头宽度
- `m_nPrtPeriod`: 打印周期
- `m_nMicroJetUnit`: 微喷单元
- `m_fFlashPrtFrequecy`: 闪喷频率

#### 3.3.2 CPrtJobDlg (打印作业对话框)
**文件**: `CPrtJobDlg.h`, `CPrtJobDlg.cpp`

**功能**:
- 打印作业参数配置
- 输出DPI设置
- 图像裁剪设置
- 打印位置设置
- 镜像和方向设置

**关键参数**:
- `m_fXOutDPI` / `m_fYOutDPI`: 输出DPI
- `m_fClipWidth` / `m_fClipHeight`: 裁剪尺寸
- `m_fXPrtPos` / `m_fYPrtPos`: 打印位置
- `m_nImageLayerCount`: 图像层数

#### 3.3.3 CImgLayerSetDlg (图像图层设置对话框)
**文件**: `CImgLayerSetDlg.h`, `CImgLayerSetDlg.cpp`

**功能**:
- 图像图层参数配置
- DPI设置
- 打印方向设置
- 羽化模式设置
- 旋转和缩放设置
- 密度控制

**关键参数**:
- `m_nXDPI` / `m_nYDPI`: 图层DPI
- `m_nPrtDir`: 打印方向
- `m_fRotateAngle`: 旋转角度
- `m_fLayerDensity`: 图层密度
- `m_nFeatherMode`: 羽化模式

#### 3.3.4 CVTSetDlg (VT设置对话框)
**文件**: `CVTSetDlg.h`, `CVTSetDlg.cpp`

**功能**:
- VT (电压/温度) 参数设置
- 打印头电压配置
- 温度控制设置

#### 3.3.5 CAdjParamDlg (调整参数对话框)
**文件**: `CAdjParamDlg.h`, `CAdjParamDlg.cpp`

**功能**:
- 打印参数调整
- 校准参数设置

#### 3.3.6 CReloadWaveDlg (重载波形对话框)
**文件**: `CReloadWaveDlg.h`, `CReloadWaveDlg.cpp`

**功能**:
- 打印头波形重载
- 波形文件管理

---

### 3.4 设备控制对话框模块

#### 3.4.1 CMoveCtlDlg (运动控制对话框)
**文件**: `CMoveCtlDlg.h`, `CMoveCtlDlg.cpp`

**功能**:
- 运动系统控制
- 移动速度设置
- 加速度设置
- 位置控制

**条件编译**: 需要定义 `RY_MOVE_CTL` 宏

#### 3.4.2 CAirInkDialog (气墨控制对话框)
**文件**: `CAirInkDialog.h`, `CAirInkDialog.cpp`

**功能**:
- 气墨系统控制
- 气压设置
- 供墨控制

#### 3.4.3 CAdibCtrlDlg (ADIB控制对话框)
**文件**: `CAdibCtrlDlg.h`, `CAdibCtrlDlg.cpp`

**功能**:
- ADIB (自适应数字墨水总线) 控制
- 气压阈值设置
- 供墨时间设置
- 清洗模式控制
- 逻辑输入监控

**关键成员**:
- `m_SigLogicInput`: 逻辑输入状态控件
- `m_AdibList`: ADIB列表控件
- `VTMonitorThread()`: VT监控线程

#### 3.4.4 CLackJetDlg (缺喷检测对话框)
**文件**: `CLackJetDlg.h`, `CLackJetDlg.cpp`

**功能**:
- 缺喷检测设置
- 喷头状态监控

---

### 3.5 自定义控件模块

#### 3.5.1 CPicScreen (图像预览控件)
**文件**: `PicScreen.h`, `PicScreen.cpp`

**功能**:
- 图像预览显示
- 位图绘制
- 预览图像生成

**MFC特性**:
- 继承自 `CStatic` (静态文本控件)
- 重写 `OnPaint()` 进行自定义绘制
- 使用 `HBITMAP` 管理位图资源

#### 3.5.2 CSWListTreeCtrl (树形列表控件)
**文件**: `RyTreeListCtl.h`, `RyTreeListCtl.cpp`

**功能**:
- 树形结构数据展示
- 多列数据显示
- 打印信息和驱动信息展示

**MFC特性**:
- 继承自 `CWnd` (窗口基类)
- 内部使用 `CSWTreeCtrl` 和 `CHeaderCtrl`
- 自定义绘制和布局

#### 3.5.3 CSWTreeCtrl (树形控件)
**文件**: `SWTreeCtrl.h`, `SWTreeCtrl.cpp`

**功能**:
- 树形数据展示
- 树节点操作

**MFC特性**:
- 继承自 `CTreeCtrl` (MFC树形控件)

#### 3.5.4 CImportListCtrl (导入列表控件)
**文件**: `ImportListCtrl.h`, `ImportListCtrl.cpp`

**功能**:
- 列表数据展示
- 数据导入功能

**MFC特性**:
- 继承自 `CListCtrl` (MFC列表控件)

#### 3.5.5 CInkStateCtrl (墨水状态控件)
**文件**: `InkStateCtrl.h`, `InkStateCtrl.cpp`

**功能**:
- 墨水状态显示
- 逻辑输入状态显示

**MFC特性**:
- 继承自 `CStatic`
- 自定义绘制

#### 3.5.6 CStaticBox (静态框控件)
**文件**: `StaticBox.h`, `StaticBox.cpp`

**功能**:
- 自定义静态框显示

**MFC特性**:
- 继承自 `CStatic`

---

### 3.6 数据结构和全局对象

#### 3.6.1 全局数据结构
定义在 `NetScanDemo.cpp` 中：
- `g_sysParam`: 系统参数 (`RYUSR_PARAM`)
- `g_movConfig`: 运动配置 (`MOV_Config`)
- `g_testJob`: 测试作业 (`PRTJOB_ITEM`)
- `g_PrtImgLayer`: 打印图像图层 (`PRTIMG_LAYER`)
- `g_Calbration`: 校准参数 (`RYCalbrationParam`)
- `g_pSysInfo`: 系统信息指针 (`LPPRINTER_INFO`)
- `g_bPHValid[]`: 打印头有效性数组

#### 3.6.2 互斥锁
- `g_PrtMutex`: 打印线程互斥锁，用于线程同步

---

## 四、核心功能模块详解

### 4.1 图像处理模块

#### 4.1.1 图像加载
`GetSrcData()` 函数负责加载打印图像：
- 支持 BMP 格式
- 支持 PRT 格式
- 支持 CLI 格式（3D打印）
- 图像数据存储在 `m_pPrtData[]` 数组中

#### 4.1.2 图像预览
`CPicScreen` 控件提供图像预览功能：
- 实时预览加载的图像
- 支持缩放显示
- 显示打印区域

### 4.2 打印控制模块

#### 4.2.1 打印API调用
通过 `RYPrtCtler.h` 接口调用底层打印控制功能：
- `IDP_StartPrintJob()`: 启动打印作业
- `IDP_StopPrintJob()`: 停止打印作业
- `DEV_*` 系列函数: 设备控制函数

#### 4.2.2 打印线程
- **PrintThread**: 主打印线程，负责数据发送
- **PrintThreadSeparate**: 分离式打印线程
- 使用互斥锁保证线程安全

### 4.3 设备监控模块

#### 4.3.1 监控线程
`MonitorThread()` 函数持续监控设备状态：
- 打印头温度
- 打印头电压
- 设备连接状态
- 更新界面显示

#### 4.3.2 状态更新
`UpdateVTListInfo()` 函数更新设备信息列表：
- 温度信息
- 电压信息
- 驱动信息

### 4.4 参数持久化模块

#### 4.4.1 文件存储
所有参数以二进制格式存储在应用程序目录：
- `userparam.dat`: 用户参数
- `pmc.dat`: 图层参数
- `job.dat`: 作业参数
- `Calibration.dat`: 校准参数
- `moveParam.dat`: 运动参数

#### 4.4.2 参数加载时机
- 应用程序启动时加载
- 对话框初始化时加载
- 用户手动加载

#### 4.4.3 参数保存时机
- 应用程序退出时保存
- 用户确认修改时保存
- 对话框关闭时保存

---

## 五、线程模型

### 5.1 主线程
- **UI线程**: 处理用户界面交互
- **消息循环**: MFC自动处理 Windows 消息

### 5.2 工作线程

#### 5.2.1 打印线程
```cpp
static UINT PrintThread(LPVOID pvoid);
static UINT PrintThreadSeparate(LPVOID pvoid);
```
- 负责打印数据发送
- 使用互斥锁同步
- 通过消息或事件通知UI线程更新

#### 5.2.2 监控线程
```cpp
static UINT MonitorThread(LPVOID lpvoid);
```
- 持续监控设备状态
- 定期更新界面显示
- 使用 `m_bStopMonitor` 标志控制退出

#### 5.2.3 预览生成线程
`CPicScreen` 中的 `m_hGenThread`:
- 异步生成预览图像
- 避免阻塞UI

---

## 六、数据流

### 6.1 图像数据流
```
图像文件 (BMP/PRT/CLI)
    ↓
GetSrcData() 加载
    ↓
m_pPrtData[] 缓冲区
    ↓
打印线程处理
    ↓
RYPrtCtler API
    ↓
打印设备
```

### 6.2 参数数据流
```
用户界面输入
    ↓
DoDataExchange() 数据交换
    ↓
对话框成员变量
    ↓
全局参数结构
    ↓
SaveParam() 保存
    ↓
.dat 文件
```

### 6.3 设备状态数据流
```
打印设备
    ↓
RYPrtCtler API
    ↓
MonitorThread 监控
    ↓
g_pSysInfo 全局数据
    ↓
UpdateVTListInfo() 更新
    ↓
界面显示
```

---

## 七、关键技术点

### 7.1 MFC特性使用
1. **消息映射**: 所有对话框和控件使用消息映射处理事件
2. **DDX/DDV**: 数据交换和验证机制
3. **对话框类**: 使用 `CDialogEx` 和 `CDialog`
4. **自定义控件**: 继承MFC控件类实现自定义功能
5. **线程管理**: 使用 `AfxBeginThread()` 创建线程

### 7.2 内存管理
- 使用 `new`/`delete` 管理动态内存
- 使用 `CString` 管理字符串（自动内存管理）
- 图像数据使用 `LPBYTE` 指针管理

### 7.3 线程同步
- 使用 `CreateMutex()` 创建互斥锁
- 使用 `WaitForSingleObject()` 等待互斥锁
- 使用布尔标志控制线程退出

### 7.4 文件操作
- 使用 `CFile` 类进行文件读写
- 二进制格式存储参数
- 使用 `CFileException` 处理异常

---

## 八、模块依赖关系

```
CNetScanDemoApp (应用程序类)
    ↓
CNetScanDemoDlg (主对话框)
    ├── CPrtJobDlg (作业配置)
    ├── CSysParamDlg (系统参数)
    ├── CImgLayerSetDlg (图层设置)
    ├── CVTSetDlg (VT设置)
    ├── CAdjParamDlg (调整参数)
    ├── CReloadWaveDlg (波形重载)
    ├── CMoveCtlDlg (运动控制) [可选]
    ├── CAirInkDialog (气墨控制)
    ├── CAdibCtrlDlg (ADIB控制)
    └── CLackJetDlg (缺喷检测)
        ↓
    自定义控件
    ├── CPicScreen (图像预览)
    ├── CSWListTreeCtrl (树形列表)
    ├── CImportListCtrl (导入列表)
    ├── CInkStateCtrl (墨水状态)
    └── CStaticBox (静态框)
        ↓
    RYPrtCtler API (外部库)
```

---

## 九、总结

### 9.1 项目特点
1. **模块化设计**: 功能按对话框模块划分，职责清晰
2. **参数管理完善**: 多类型参数持久化存储
3. **多线程架构**: UI线程和工作线程分离
4. **自定义控件**: 丰富的自定义控件满足特殊需求
5. **设备控制**: 完整的打印设备控制接口

### 9.2 适用场景
- 工业喷墨打印设备控制
- 网络扫描式打印系统
- 多图层打印作业管理
- 打印参数配置和管理

### 9.3 扩展方向
1. 支持更多图像格式
2. 增强错误处理和日志记录
3. 优化线程同步机制
4. 添加网络通信功能
5. 支持多设备管理


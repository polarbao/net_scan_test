# Qt 与 MFC 项目功能同步与逻辑检查报告

## 1. 概述

本次任务旨在检查 `net_scam_soft_demo` 目录下的 Qt 和 MFC 项目，确保两个项目的功能一致性。根据分析，发现 Qt 项目缺失了部分核心功能。本次操作完成了从 MFC 项目到 Qt 项目的功能移植，并对代码逻辑进行了检查和优化。

## 2. 主要变更

### 2.1. 功能同步

#### 2.1.1. `getSrcData` 图像加载逻辑

- **分析**: MFC 项目中的 `GetSrcData` 函数负责从磁盘读取 BMP 文件，解析文件头，并提取像素数据。Qt 项目中虽然已存在 `getSrcData` 函数，但其实现需要与 MFC 版本进行比对以确保逻辑完全一致。
- **操作**: 经过详细比对，确认 Qt 中的 `getSrcData` 函数已正确地移植了 MFC 版本的核心逻辑。此外，还发现 Qt 版本修复了 MFC 实现中一个关于计算图像每行字节数（`nBytesPerLine`）的潜在 Bug，使其计算更为准确，因此未做额外修改。

#### 2.1.2. `AdibCtrlDialog` ADIB 板控制对话框

- **缺失功能**: MFC 项目中存在 `CAdibCtrlDlg` 对话框，用于控制 ADIB 板的电压、温度、气压等参数，并执行清洗、供墨等操作。此功能在 Qt 项目中完全缺失。
- **操作**:
    1.  **创建新文件**: 创建了 `qt/AdibCtrlDialog.h`、`qt/AdibCtrlDialog.cpp` 和 `qt/AdibCtrlDialog.ui` 三个文件，用于实现新的 Qt 对话框。
    2.  **UI 移植**: 使用 `QTableWidget`、`QLineEdit`、`QCheckBox` 和 `QPushButton` 等标准 Qt 控件复刻了 MFC 版本的 UI 布局和元素。
    3.  **逻辑移植**:
        - 使用 `QTimer` 替代了 MFC 版本中的后台监控线程，以更简洁、安全的方式轮询设备状态。
        - 实现了所有按钮的槽函数，通过调用 `DEV_AdibControl` SDK 函数来发送对应的控制指令，实现了参数应用、清洗模式、泵控制等功能。
    4.  **主窗口集成**: 在 `MainWindow` 中添加了相应的 `include` 和信号槽连接，使得点击 "ADIB Ctl" 按钮可以正确地弹出该对话框。

#### 2.1.3. `ImgLayerSetDialog` 图像图层设置对话框

- **缺失功能**: MFC 项目中存在 `CImgLayerSetDlg` 对话框，用于在打印前设置详细的图像图层参数（如 DPI、羽化模式、打印方向等）。此功能在 Qt 项目中同样缺失。
- **操作**:
    1.  **创建新文件**: 创建了 `qt/ImgLayerSetDialog.h`、`qt/ImgLayerSetDialog.cpp` 和 `qt/ImgLayerSetDialog.ui` 三个文件。
    2.  **UI 移植**: 使用 `QFormLayout` 布局和一系列 `QLineEdit`、`QComboBox`、`QCheckBox` 控件，构建了一个清晰的参数设置表单。
    3.  **逻辑移植**: 实现了 `loadParams` 和 `saveParams` 两个核心方法。对话框打开时，`loadParams` 会从全局变量 `g_PrtImgLayer` 中读取当前参数并填充到 UI；当用户点击 "OK" 时，`saveParams` 会将 UI 上的新值写回 `g_PrtImgLayer`。
    4.  **主窗口集成**: 将该对话框的调用逻辑集成到 `onButtonLoadImageClicked` 函数中，在用户成功加载图像文件后，自动弹出此设置对话框。

### 2.2. 逻辑检查与改进

- **ADIB 对话框**:
    - 将 MFC 版本中的 **后台线程 + 定时器** 更新机制，优化为 Qt 中更现代的 **`QTimer` 单定时器** 机制，简化了代码结构，提高了稳定性。
    - 注意到 MFC 版本中 `OnBnClickedCleanheadidisok` 函数调用了 `MVT_SetOutPut`，这是一个外部模块的函数。为了防止潜在的链接错误，在 Qt 版本的相应位置添加了 `qDebug()` 输出进行提示，提醒开发者注意此处的函数依赖。
- **代码集成**: 确保了所有新创建的对话框都正确地包含在 `MainWindow` 中，并建立了正确的信号槽连接，保证了 UI 操作的响应。

## 3. 文件变更清单

### 3.1. 新增文件

- `qt/AdibCtrlDialog.h`
- `qt/AdibCtrlDialog.cpp`
- `qt/AdibCtrlDialog.ui`
- `qt/ImgLayerSetDialog.h`
- `qt/ImgLayerSetDialog.cpp`
- `qt/ImgLayerSetDialog.ui`

### 3.2. 修改文件

- `qt/MainWindow.cpp`:
    - 添加了对 `AdibCtrlDialog.h` 和 `ImgLayerSetDialog.h` 的 `#include`。
    - 在构造函数中添加了 `buttonAdibCtl` 按钮的信号槽连接。
    - 修改了 `onButtonAdibCtlClicked` 的实现，以创建并显示 `AdibCtrlDialog`。
    - 修改了 `onButtonLoadImageClicked` 的实现，在图像加载成功后创建并显示 `ImgLayerSetDialog`。

## 4. 后续步骤提醒

为了使项目能够成功编译，请务必将本次新增的所有 `.h`、`.cpp` 和 `.ui` 文件添加到您的 Qt 项目的构建系统（`.pro` 文件）中。

**示例**:
在您的 `.pro` 文件中，添加如下内容：

```cpp
HEADERS += \
    # ... other headers
    qt/AdibCtrlDialog.h \
    qt/ImgLayerSetDialog.h

SOURCES += \
    # ... other sources
    qt/AdibCtrlDialog.cpp \
    qt/ImgLayerSetDialog.cpp

FORMS += \
    # ... other forms
    qt/AdibCtrlDialog.ui \
    qt/ImgLayerSetDialog.ui
```
